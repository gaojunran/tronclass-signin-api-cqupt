name: Daily Cookie Refresh

on:
  schedule:
    # Run daily at 10:00 AM UTC (adjust timezone as needed)
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main
      - dev

jobs:
  refresh-cookies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
          
      - name: Verify Chromium installation
        run: |
          echo "Checking Chromium installation..."
          which chromium-browser || echo "chromium-browser not found"
          which chromium || echo "chromium not found"
          ls -la /usr/bin/chromium* || echo "No chromium executables found"
          chromium-browser --version || chromium --version || echo "Cannot get version"
          
      - name: Check environment
        run: |
          echo "=== Environment Check ==="
          echo "Deno version: $(deno --version)"
          echo "Working directory: $(pwd)"
          echo "Script exists: $(test -f scripts/identity-refresh-cookies.ts && echo 'YES' || echo 'NO')"
          echo "API endpoint: https://tronclass.codenebula.deno.net"
          echo "Testing API connectivity..."
          curl -v https://tronclass.codenebula.deno.net/user/list || echo "API connection failed"
          
      - name: Run cookie refresh script
        id: refresh
        run: |
          echo "Starting cookie refresh script..."
          deno run -A scripts/identity-refresh-cookies.ts 2>&1 | tee refresh_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          echo "Script exit code: $EXIT_CODE"
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        continue-on-error: true

      - name: Read output
        id: output
        run: |
          OUTPUT=$(cat refresh_output.txt)
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Cookie Refresh Task - ${{ steps.refresh.outputs.exit_code == '0' && 'Success' || 'Failed' }}"
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions
          body: |
            Cookie Refresh Task Execution Report
            =====================================
            
            Status: ${{ steps.refresh.outputs.exit_code == '0' && 'Success ✅' || 'Failed ❌' }}
            Time: ${{ github.event.repository.updated_at }}
            Repository: ${{ github.repository }}
            
            Execution Output:
            -----------------
            ${{ steps.output.outputs.output }}
            
            ---
            This is an automated message from GitHub Actions.
