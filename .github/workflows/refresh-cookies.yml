name: Daily Cookie Refresh

on:
  schedule:
    # Run daily at 10:00 AM UTC (adjust timezone as needed)
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main
      - dev

jobs:
  refresh-cookies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
          
      - name: Verify Chromium installation
        run: |
          echo "Checking Chromium installation..."
          which chromium-browser || echo "chromium-browser not found"
          which chromium || echo "chromium not found"
          ls -la /usr/bin/chromium* || echo "No chromium executables found"
          chromium-browser --version || chromium --version || echo "Cannot get version"
          
      - name: Check environment
        run: |
          echo "=== Environment Check ==="
          echo "Deno version: $(deno --version)"
          echo "Working directory: $(pwd)"
          echo "Script exists: $(test -f scripts/identity-refresh-cookies.ts && echo 'YES' || echo 'NO')"
          echo "API endpoint: https://tronclass.codenebula.deno.net"
          echo "Testing API connectivity..."
          curl -v https://tronclass.codenebula.deno.net/user/list || echo "API connection failed"
          
      - name: Run cookie refresh script
        id: refresh
        run: |
          echo "Starting cookie refresh script..."
          deno run -A scripts/identity-refresh-cookies.ts 2>&1 | tee refresh_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          echo "Script exit code: $EXIT_CODE"
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        continue-on-error: true

      - name: Generate execution report
        if: always()
        run: |
          echo "## ðŸ”„ Cookie Refresh Task Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.refresh.outputs.exit_code }}" == "0" ]; then
            echo "### âœ… Status: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Execution Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat refresh_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
      - name: Check execution status
        if: steps.refresh.outputs.exit_code != '0'
        run: |
          echo "::error::Cookie refresh task failed with exit code ${{ steps.refresh.outputs.exit_code }}"
          exit 1
