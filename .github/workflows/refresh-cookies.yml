name: Daily Cookie Refresh

on:
  schedule:
    # Run daily at 10:00 AM UTC (adjust timezone as needed)
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main
      - dev

jobs:
  refresh-cookies:
    runs-on: ubuntu-latest
    # Only run scheduled tasks on dev branch
    if: github.event_name != 'schedule' || github.ref == 'refs/heads/dev'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Install system dependencies for Puppeteer
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libxshmfence1 \
            libglib2.0-0 \
            libasound2t64 || sudo apt-get install -y libasound2
          
      - name: Check environment
        run: |
          echo "=== Environment Check ==="
          echo "Deno version: $(deno --version)"
          echo "Working directory: $(pwd)"
          echo "Script exists: $(test -f scripts/identity-refresh-cookies.ts && echo 'YES' || echo 'NO')"
          echo "API endpoint: https://tronclass.codenebula.deno.net"
          echo "Testing API connectivity..."
          curl -v https://tronclass.codenebula.deno.net/user/list || echo "API connection failed"
          
      - name: Run cookie refresh script (with retry)
        id: refresh
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "Starting cookie refresh script..."
            deno run -A scripts/identity-refresh-cookies.ts 2>&1 | tee refresh_output.txt
            EXIT_CODE=${PIPESTATUS[0]}
            echo "Script exit code: $EXIT_CODE"
            echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
            exit $EXIT_CODE
          on_retry_command: |
            echo "âš ï¸ Attempt failed, retrying in 30 seconds..."
        continue-on-error: true

      - name: Generate execution report
        if: always()
        run: |
          echo "## ðŸ”„ Cookie Refresh Task Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.refresh.outcome }}" == "success" ]; then
            echo "### âœ… Status: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: Failed (after ${{ steps.refresh.outputs.total_attempts || '1' }} attempts)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Execution Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat refresh_output.txt 2>/dev/null || echo "No output file found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
      - name: Check execution status
        if: steps.refresh.outcome != 'success'
        run: |
          echo "::error::Cookie refresh task failed after ${{ steps.refresh.outputs.total_attempts || '3' }} attempts"
          exit 1
